<!DOCTYPE html>
<html lang="zn">

<head>
  <meta charset="UTF-8">
  <title>中医智诊</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #title {
      position: absolute;
      top: 50px; /* 向下移动标题 */
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 24px;
      color: black;
    }
    #background {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    #image1 {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20%;
      z-index: 1;
    }

    #image2 {
      position: fixed;
      top: 0;
      left: 0;
      width: 15%;
      z-index: 2;
    }

    #image3 {
      position: fixed;
      top: 0;
      right: 0;
      width: 20%;
      z-index: 3;
    }

    #image4 {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 20%;
      z-index: 4;
    }

    #cloud {
      width: 50%;
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      animation: moveCloud 15s infinite linear both;
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    @keyframes moveCloud {
      0% {
        transform: translateX(-100%) translateY(-50%);
      }
      100% {
        transform: translateX(100%) translateY(-50%);
      }
    }

    #videoWrapper {
      position: fixed;
      top: 40%;
      left: 45%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 250px;
      z-index: 5;
    }

    #inputVideo {
      width: 400px;
      height: 350px;
      /* 可以添加以下属性来让视频内容在 wrapper 内居中显示（如果视频尺寸大于 wrapper） */
      display: block;
      margin: 0 auto;
    }

    #captureButton {
      position: fixed;
      bottom: 100px; /* 调整按钮位置 */
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: green; /* 按钮背景颜色 */
      color: white; /* 按钮文字颜色 */
      border: none; /* 去除边框 */
      border-radius: 5px; /* 圆角 */
      transition: background-color 0.3s, transform 0.3s; /* 平滑过渡效果 */
      z-index: 5; /* 确保按钮在其他元素之上 */
    }

    #captureButton:hover {
      background-color: #54beb9; /* 鼠标悬停时的背景颜色 */
    }
  </style>
</head>

<body>
  <div id="title">本草智诊</div>
  <img id="background" src='/static/app1/images/总背景.png' alt="背景">
  <img id="image1" src='/static/app1/images/树枝.png' alt="图一">
  <img id="image2" src='/static/app1/images/左手.png' alt="图二">
  <img id="image3" src='/static/app1/images/右树.png' alt="图三">
  <img id="image4" src='/static/app1/images/右手.png' alt="图四">
  <img id="cloud" src='/static/app1/images/祥云.png' alt="Cloud">

  <!-- 新增视频框和按钮 -->
  <div id="videoWrapper">
    <video id="inputVideo" autoplay muted></video>
  </div>
  <button id="captureButton">登录/注册</button>

  <script src="/static/app1/js/face-api.js"></script>
  <script>
    let labeledFaceDescriptors = []; // 存储面部特征描述符

    // 从后端加载面部数据
    function loadFaceData() {
      fetch('/load-face-data/', {
        method: 'GET',
      })
       .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load data');
          }
          return response.json();
        })
       .then(data => {
          console.log('Loaded face data:', data);
          // 在这里，你可以对加载的数据做一些处理
          // 例如，初始化面部识别的数据
          labeledFaceDescriptors = data.map(item => new faceapi.LabeledFaceDescriptors(
            item.label,
            item.descriptors.map(d => new Float32Array(d)) // 转回 Float32Array
          ));
        })
       .catch(error => console.error('Error loading data:', error));
    }

    // 保存数据到 localStorage
    function saveFaceData() {
      const faceData = labeledFaceDescriptors.map(descriptor => ({
        label: descriptor.label,
        descriptors: descriptor.descriptors.map(d => Array.from(d)) // 转为普通数组
      }));
      localStorage.setItem('faceData', JSON.stringify(faceData));
    }

    // 从 localStorage 加载数据
    function loadFaceDataFromLocalStorage() {
      const data = localStorage.getItem('faceData');
      if (!data) return [];
      const faceData = JSON.parse(data);
      return faceData.map(item => new faceapi.LabeledFaceDescriptors(
        item.label,
        item.descriptors.map(d => new Float32Array(d)) // 转回 Float32Array
      ));
    }

    async function run() {
      // 加载模型
      await faceapi.nets.ssdMobilenetv1.loadFromUri('/static/app1/models');
      await faceapi.nets.faceLandmark68Net.loadFromUri('/static/app1/models');
      await faceapi.nets.faceRecognitionNet.loadFromUri('/static/app1/models');

      // 初始化摄像头视频流
      const videoEl = document.getElementById('inputVideo');
      const canvas = document.createElement('canvas'); // 创建一个画布用于绘制面部识别结果
      document.body.appendChild(canvas); // 将画布添加到页面中

      labeledFaceDescriptors = loadFaceDataFromLocalStorage(); // 从 localStorage 加载已保存的数据

      // 从后端加载面部数据
      loadFaceData(); // 后端加载

      navigator.mediaDevices.getUserMedia({ video: {} })
       .then(stream => videoEl.srcObject = stream)
       .catch(err => console.error('Error accessing webcam: ', err));

      videoEl.addEventListener('play', () => {
        const displaySize = { width: videoEl.videoWidth, height: videoEl.videoHeight };
        canvas.width = displaySize.width;
        canvas.height = displaySize.height;
        faceapi.matchDimensions(canvas, displaySize);

        setInterval(async () => {
          const detections = await faceapi.detectAllFaces(videoEl)
           .withFaceLandmarks()
           .withFaceDescriptors();

          const resizedDetections = faceapi.resizeResults(detections, displaySize);
          canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
          faceapi.draw.drawDetections(canvas, resizedDetections);
          faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
        }, 100);
      });

      // 点击按钮进行注册或登录
      const captureButton = document.getElementById('captureButton');
      captureButton.addEventListener('click', async () => {
        const detections = await faceapi.detectAllFaces(videoEl)
         .withFaceLandmarks()
         .withFaceDescriptors();

        if (detections.length === 0) {
          alert("No face detected. Please try again!");
          return;
        }

        const faceDescriptor = detections[0].descriptor;

        // 如果没有已注册用户，直接注册
        if (labeledFaceDescriptors.length === 0) {
          const name = prompt("面部特征不存在，请输入你的名字作为用户名:");
          if (name) {
            const labeledDescriptor = new faceapi.LabeledFaceDescriptors(
              name, [faceDescriptor]
            );
            labeledFaceDescriptors.push(labeledDescriptor);
            saveFaceData(); // 保存数据
            alert(`注册成功,欢迎你, ${name}.`);
            // 注册成功后跳转
            window.location.href = '/主页';
          }
          return;
        }

        // 尝试匹配现有用户
        const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors);
        const bestMatch = faceMatcher.findBestMatch(faceDescriptor);

        if (bestMatch.label!== 'unknown') {
          alert(`欢迎回来, ${bestMatch.label}! 你已经登录.`);
          // 登录成功后跳转
          window.location.href = '/主页';
        } else {
          const name = prompt("面部特征不存在，请输入你的名字作为用户名:");
          if (name) {
            const labeledDescriptor = new faceapi.LabeledFaceDescriptors(
              name, [faceDescriptor]
            );
            labeledFaceDescriptors.push(labeledDescriptor);
            saveFaceData(); // 保存数据
            alert(`注册成功,欢迎你 ${name}.`);
            // 注册成功后跳转
            window.location.href = '/主页';
          }
        }
      });
    }

    run();
  </script>
</body>

</html>